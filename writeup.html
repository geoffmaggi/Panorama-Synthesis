<html><head>  <title>CS 410 Project 2 Writeup</title>  <meta http-equiv="Content-Type" content="text/html; charset=gb2312">
  <style type="text/css">    h1{margin:0px; text-align:center;}    h2{margin:0px; text-align:center;}    h3{margin:0px; text-align:center;}    img{height:20%;}    img:hover{height:60%;}    .csharpcode, .csharpcode pre    {      font-size: small;      color: black;      font-family: Consolas, "Courier New", Courier, Monospace;      background-color: #ffffff;      /*white-space: pre;*/    }    .csharpcode pre { margin: 0em; }    .csharpcode .rem { color: #008000; }    .csharpcode .kwrd { color: #0000ff; }    .csharpcode .str { color: #a31515; }    .csharpcode .op { color: #0000c0; }    .csharpcode .preproc { color: #cc6633; }    .csharpcode .asp { background-color: #ffff00; }    .csharpcode .html { color: #800000; }    .csharpcode .attr { color: #ff0000; }    .csharpcode .alt     {      background-color: #f4f4f4;      width: 100%;      margin: 0em;    }    .csharpcode .lnum { color: #606060; }
  </style></head><body>
<h1>Project 2 Writeup</h1><h2>Geoff Maggi</h2><h2>Winter 2016</h2><hr/><p><b>Project:</b> Panorama Synthesis</p><p><b>Assignment:</b> <a href="http://web.cecs.pdx.edu/~fliu/courses/cs410/prj2.htm">Link to Assignment Outline</a></p><p><b>Sources:</b></p><ul>  <li><a href="http://www.cs.ubc.ca/~lowe/papers/07brown.pdf">Matthew Brown and David G. Lowe, "Automatic panoramic image stitching using invariant features," International Journal of Computer Vision, 74, 1 (2007)</a></li>  <li><a href="http://www.emgu.com/wiki/index.php/Documentation">Emgu CV Documentation</a></li>  <li><a href="http://www.aforgenet.com/framework/docs/">AForge.NET Documentation</a></li>  <li><a href="http://accord-framework.net/docs/html/R_Project_Accord_NET.htm">Accord.NET Documentation</a></li></ul><p><b>Source Code:</b></p><div style="margin-left:20px;">  <p>The project was written as an ASP.NET Web Application with a C# Backend</p>  <p><b>A Live Demo can be viewed here:</b> <a href="http://cv.laxer.net/Panorama%20Synthesis/">Panorama Synthesis</a> (<i>Note: When deployed on a server it has a memory bug right now, resulting in some intermittent interesting behavior</i>)</p>  <p>You can download the source code here: <a href="http://cv.laxer.net/Panorama%20Synthesis/project.zip">Source Code</a></p>  <p><b>The source code is also attached at the bottom of this page.</b></p>    <p><b>Note:</b> To run the source code you may need to grab the following NuGet Packages: Emgu CV, AForge, AForge Imaging, AForge Imaging, AForge Math, Accord, Accord Imaging, Accord Math, Accord Statistics</p></div><hr/><p><b>Task:</b></p><div style="margin-left:20px;">  <p>a. The goal of this project is to develop a panoramic image synthesis system. You can either implement the basic stitching algorithm in [1] or use the algorithms/APIs implemented in OpenCV. (40 points)<br/>  b. Experiment with at least two image blending algorithms, such as those provided by OpenCV (10 points)<br/>  c. Implement the panorama straightening algorithm in [1] or come up with your own way to straighten a panorama  (10 points)<br/>  d. In-class presentation (0-10 points)<br/>  e. Project report (0-20 points)</p></div><p><b>Additions:</b></p><div style="margin-left:20px;">  <p>+ More feature detection algorithms<br/>+ more feature correlation algorithms<br/>+ more blending algorithms</p></div><hr/><h2>About:</h2><p>This project started out as described in the task above, while working on setting up the project I ran into linking issues with OpenCV and decided to go with a few avalible opensource wrappers(See sources above)</p><p>In the libraries I was using SIFT was not avalible due to licensing issues so I started out by using <a href="https://en.wikipedia.org/wiki/Speeded_up_robust_features">SURF</a>.<p><p><b>Note</b>: The program reads in JPEG images in any order and always attempts to stitch them together. If the images aren to a good match you will get interesting results!</p><div style="margin-left:20px;">  <p><b>Step 1: Identify Features</b></p>  <div style="margin-left:20px;">    <p>I made use of the <a href="http://accord-framework.net/docs/html/T_Accord_Imaging_SpeededUpRobustFeaturesDetector.htm">SpeededUpRobustFeaturesDetector</a> implemented in the Accord Framework to detect features.<p>    <table>      <tr><th>Input:</th><th>Output:</th></tr>      <tr><td><img src="imgs/surf/2.jpg"></td><td><img src="imgs/surf/2-out.jpg"></td></tr>      <tr><td><img src="imgs/surf/3.jpg"></td><td><img src="imgs/surf/3-out.jpg"></td></tr>    </table>  </div>    <p><b>Step 2: Feature Mapping</b></p>  <div style="margin-left:20px;">    <p>To map the features from one img to the next I use a <a href="https://en.wikipedia.org/wiki/Nearest_neighbor_search">Nearest Neighbor Search</a>, I found that looking at the 10 nearest neigbors and a 10% threshhold yielded the best results.<p>    <table>      <tr><th>Input:</th><th>Output:</th></tr>      <tr><td><img src="imgs/surf/2.jpg">, <img src="imgs/surf/3.jpg"></td><td><img src="imgs/surf/2+3.jpg"></td></tr>      <tr><td><img src="imgs/surf/3.jpg">, <img src="imgs/surf/4.jpg"></td><td><img src="imgs/surf/3+4.jpg"></td></tr>      <tr><td><img src="imgs/surf/2.jpg">, <img src="imgs/surf/3.jpg">, <img src="imgs/surf/4.jpg"></td><td><img src="imgs/surf/2+3+4.jpg"></td></tr>    </table>  </div>    <p><b>Step 3: Homography Estimation and Blending</b></p>  <div style="margin-left:20px;">    <p>I used <a href="https://en.wikipedia.org/wiki/RANSAC">RANSAC</a> to estimate the Homography then used that to apply a gradient blend to the images. (In my testing I found the gradient blend to perform the best although I also tested linear and multi-band. Multi-band looked slightly better but, took far longer to compute). I then used the corner points from the Homography data to apply a small filter to feather the edge a bit more.<p>    <table>      <tr><th>Input:</th><th>Output:</th></tr>      <tr><td><img src="imgs/surf/2.jpg">, <img src="imgs/surf/3.jpg"></td><td><img src="imgs/surf/2+3-blend.jpg"></td></tr>      <tr><td><img src="imgs/surf/3.jpg">, <img src="imgs/surf/4.jpg"></td><td><img src="imgs/surf/3+4-blend.jpg"></td></tr>      <tr><td><img src="imgs/surf/2.jpg">, <img src="imgs/surf/3.jpg">, <img src="imgs/surf/4.jpg"></td><td><img src="imgs/surf/2+3+4-blend.jpg"></td></tr>    </table>  </div>    <p><b>Step 4: Straighten</b></p>  <div style="margin-left:20px;">    <p>To straighten the panorama I used a <a href="https://en.wikipedia.org/wiki/Canny_edge_detector">Canny Edge Detector</a> to identify prominent edges. I then found the most prominent edge across the two images I was trying to join and rotated the second image so that the edge was normal parallel to the X-plane.<p>    <p>The image below shows an example. The first row are the input images rotated before joining. The bottom row is the images joined together without opacity from the rotation.</p>    <img src="imgs/surf/straight.jpg">    <p>The last thing to do is to remove the alpha channel after rotating and before joining to make the white part around the outside transparent. Below is the final result.</p>    <img src="imgs/surf/done.jpg">  </div></div><p>&nbsp;</p><hr/><h2>Extras!</h2><p>From here the project is technically done but, I was curious how other options would perform.</p><p>In addition to SURF I used two Implementations of a <a href="https://en.wikipedia.org/wiki/Corner_detection#The_Harris_.26_Stephens_.2F_Plessey_.2F_Shi.E2.80.93Tomasi_corner_detection_algorithms">Harris Corner Detector</a> and an implementation of a <a href="http://infoscience.epfl.ch/record/175537/files/2069.pdf">FREAK Detector</a>.</p><p>Both implementations of the Harris detector are the same however, I used two different mapping algorithms which yielded very different results. The first one used a large window around keypoints which allowed for a very accurate mapping from one image to another. The downfall is that it takes FOREVER to computer as I am manually comparing a bunch of pixels!</p><p>The second mapping algorithm uses a small window then takes only the inliers from a homography estimation using <a href="https://en.wikipedia.org/wiki/RANSAC">RANSAC</a>. This is much faster but, no where near as accurate.</p><p>&nbsp;</p><p>For the FREAK Detector I mapped the keypoints similar to how I did for SURF by using a <a href="https://en.wikipedia.org/wiki/Nearest_neighbor_search">Nearest Neighbor Search</a>. The FREAK detector however finds many more keypoints in an image than the SURF Detector does so I had to tweak the settings of the Nearest Neighbor Search to look at more neighbors and have a tigher tolerance.</p><p>In my testing I found that the FREAK Detector performed the best per computation time on my image sets.</p><h2>Below are random images comparing the detection and maping algorithms</h2>    <table>      <tr><th>Input:</th><th>Output:</th></tr>      <tr><td><img src="imgs/surf/2.jpg"></td><td><img src="imgs/Feature Finding/surf.jpg"><img src="imgs/Feature Finding/freak.jpg"><img src="imgs/Feature Finding/harris.jpg"></td></tr>      <tr><td><img src="imgs/surf/1.jpg">, <img src="imgs/surf/2.jpg">, <img src="imgs/surf/3.jpg">, <img src="imgs/surf/4.jpg"></td><td><img src="imgs/Feature Matching/fastHarris.jpg"></td></tr>      <tr><td><img src="imgs/surf/1.jpg">, <img src="imgs/surf/2.jpg">, <img src="imgs/surf/3.jpg">, <img src="imgs/surf/4.jpg"></td><td><img src="imgs/Feature Matching/Harris.jpg"></td></tr>      <tr><td><img src="imgs/surf/1.jpg">, <img src="imgs/surf/2.jpg">, <img src="imgs/surf/3.jpg">, <img src="imgs/surf/4.jpg"></td><td><img src="imgs/Feature Matching/freak.jpg"></td></tr>      <tr><td><img src="imgs/surf/1.jpg">, <img src="imgs/surf/2.jpg">, <img src="imgs/surf/3.jpg">, <img src="imgs/surf/4.jpg"></td><td><img src="imgs/Feature Matching/surf.jpg"></td></tr>    </table>    <hr/> <h2>Image Patching Example</h2><p>Here is an example I thought was cool, I took my background from work, sliced it up into a bunch of pieces and let me program sitch it all back together! (There is slight warping but it is very close to the original!)<p><div style="margin-left:20px;">  <p><b>Inputs:</b></p>  <div style="margin-left:20px;">    <img src="imgs/cropped/1.jpg">    <img src="imgs/cropped/6.jpg">    <img src="imgs/cropped/5.jpg"><br/>    <img src="imgs/cropped/7.jpg">    <img src="imgs/cropped/2.jpg">    <img src="imgs/cropped/3.jpg"><br/>    <img src="imgs/cropped/4.jpg">    <img src="imgs/cropped/8.jpg">    <img src="imgs/cropped/10.jpg"><br/>    <img src="imgs/cropped/9.jpg">  </div>  <p><b>Output:</b></p>  <div style="margin-left:20px;">    <img src="imgs/cropped/done.jpg">  </div></div>     <hr/> <h2>Source Code</h2> <p>Front End Form (ASP.Net)</p> <div style="height:400px; overflow:auto; border:2px solid black;">    <div class="csharpcode">    <pre class="alt"><span class="asp">&lt;%@ Page Language="C#" AutoEventWireup="true" CodeFile="Default.aspx.cs" Inherits="_Default" %&gt;</span></pre>    <pre>&nbsp;</pre>    <pre class="alt"><span class="kwrd">&lt;!</span><span class="html">DOCTYPE</span> <span class="attr">html</span> <span class="attr">PUBLIC</span> <span class="kwrd">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span> <span class="kwrd">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span><span class="kwrd">&gt;</span></pre>    <pre>&nbsp;</pre>    <pre class="alt"><span class="kwrd">&lt;</span><span class="html">html</span> <span class="attr">xmlns</span><span class="kwrd">="http://www.w3.org/1999/xhtml"</span><span class="kwrd">&gt;</span></pre>    <pre><span class="kwrd">&lt;</span><span class="html">head</span> <span class="attr">id</span><span class="kwrd">="Head1"</span> <span class="attr">runat</span><span class="kwrd">="server"</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">    <span class="kwrd">&lt;</span><span class="html">title</span><span class="kwrd">&gt;&lt;/</span><span class="html">title</span><span class="kwrd">&gt;</span></pre>    <pre><span class="kwrd">&lt;/</span><span class="html">head</span><span class="kwrd">&gt;</span></pre>    <pre class="alt"><span class="kwrd">&lt;</span><span class="html">body</span><span class="kwrd">&gt;</span></pre>    <pre>    <span class="kwrd">&lt;</span><span class="html">form</span> <span class="attr">id</span><span class="kwrd">="form1"</span> <span class="attr">runat</span><span class="kwrd">="server"</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">    <span class="kwrd">&lt;</span><span class="html">asp:Label</span> <span class="attr">ID</span><span class="kwrd">="debug"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="kwrd">/&gt;</span></pre>    <pre>    <span class="kwrd">&lt;</span><span class="html">div</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">      <span class="kwrd">&lt;</span><span class="html">p</span><span class="kwrd">&gt;&lt;</span><span class="html">b</span><span class="kwrd">&gt;</span>Sources: <span class="kwrd">&lt;/</span><span class="html">b</span><span class="kwrd">&gt;&lt;</span><span class="html">asp:FileUpload</span> <span class="attr">ID</span><span class="kwrd">="sourcesFU"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="attr">Multiple</span><span class="kwrd">="Multiple"</span><span class="kwrd">/&gt;&lt;/</span><span class="html">p</span><span class="kwrd">&gt;</span></pre>    <pre>      <span class="kwrd">&lt;</span><span class="html">p</span><span class="kwrd">&gt;&lt;</span><span class="html">b</span><span class="kwrd">&gt;</span>Task: <span class="kwrd">&lt;/</span><span class="html">b</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">          <span class="kwrd">&lt;</span><span class="html">asp:DropDownList</span> <span class="attr">ID</span><span class="kwrd">="taskDDL"</span> <span class="attr">runat</span><span class="kwrd">="server"</span><span class="kwrd">&gt;</span></pre>    <pre>              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="Fast Harris + RANSAC + Blend"</span> <span class="attr">Value</span><span class="kwrd">="fastHarrisRansacBlend"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="Harris + RANSAC + Blend"</span> <span class="attr">Value</span><span class="kwrd">="harrisRansacBlend"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre>              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="SURF + RANSAC + Blend"</span> <span class="attr">Value</span><span class="kwrd">="surfRansacBlend"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="FREAK + RANSAC + Blend"</span> <span class="attr">Value</span><span class="kwrd">="freakRansacBlend"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre>              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="Fast Harris + RANSAC + Blend + Straight"</span> <span class="attr">Value</span><span class="kwrd">="fastHarrisRansacBlendStraight"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="Harris + RANSAC + Blend + Straight"</span> <span class="attr">Value</span><span class="kwrd">="harrisRansacBlendStraight"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre>              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="SURF + RANSAC + Blend + Straight"</span> <span class="attr">Value</span><span class="kwrd">="surfRansacBlendStraight"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="Fast Harris Feature Correlation"</span> <span class="attr">Value</span><span class="kwrd">="fastHarrisFeaturesCorrelation"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre>              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="Harris Feature Correlation"</span> <span class="attr">Value</span><span class="kwrd">="harrisFeaturesCorrelation"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="SURF Feature Correlation"</span> <span class="attr">Value</span><span class="kwrd">="surfFeaturesCorrelation"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre>              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="FREAK Feature Correlation"</span> <span class="attr">Value</span><span class="kwrd">="freakFeaturesCorrelation"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="Harris Feature Detection"</span> <span class="attr">Value</span><span class="kwrd">="harrisFeatures"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre>              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="SURF Feature Detection"</span> <span class="attr">Value</span><span class="kwrd">="surfFeatures"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">              <span class="kwrd">&lt;</span><span class="html">asp:ListItem</span> <span class="attr">Text</span><span class="kwrd">="FREAK Feature Detection"</span> <span class="attr">Value</span><span class="kwrd">="freakFeatures"</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:ListItem</span><span class="kwrd">&gt;</span></pre>    <pre>          <span class="kwrd">&lt;/</span><span class="html">asp:DropDownList</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="kwrd">&lt;/</span><span class="html">p</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">      <span class="kwrd">&lt;</span><span class="html">asp:Button</span> <span class="attr">ID</span><span class="kwrd">="runBtn"</span> <span class="attr">text</span><span class="kwrd">="Run!"</span> <span class="attr">OnClick</span><span class="kwrd">="run"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="kwrd">/&gt;</span></pre>    <pre>      <span class="kwrd">&lt;</span><span class="html">asp:Button</span> <span class="attr">ID</span><span class="kwrd">="clearBtn"</span> <span class="attr">text</span><span class="kwrd">="Clear!"</span> <span class="attr">OnClick</span><span class="kwrd">="clear"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="kwrd">/&gt;</span></pre>    <pre class="alt">      <span class="kwrd">&lt;</span><span class="html">hr</span> <span class="kwrd">/&gt;</span></pre>    <pre>      <span class="kwrd">&lt;</span><span class="html">asp:ScriptManager</span> <span class="attr">ID</span><span class="kwrd">="ScriptManager1"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="kwrd">/&gt;</span></pre>    <pre class="alt">      <span class="kwrd">&lt;</span><span class="html">asp:UpdatePanel</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="attr">ID</span><span class="kwrd">="imageUP"</span><span class="kwrd">&gt;</span></pre>    <pre>       <span class="kwrd">&lt;</span><span class="html">ContentTemplate</span><span class="kwrd">&gt;&lt;/</span><span class="html">ContentTemplate</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">      <span class="kwrd">&lt;/</span><span class="html">asp:UpdatePanel</span><span class="kwrd">&gt;</span></pre>    <pre>    <span class="kwrd">&lt;/</span><span class="html">div</span><span class="kwrd">&gt;</span></pre>    <pre class="alt">    <span class="kwrd">&lt;/</span><span class="html">form</span><span class="kwrd">&gt;</span></pre>    <pre><span class="kwrd">&lt;/</span><span class="html">body</span><span class="kwrd">&gt;</span></pre>    <pre class="alt"><span class="kwrd">&lt;/</span><span class="html">html</span><span class="kwrd">&gt;</span></pre>    </div> </div> <p>Back End Code (C#)</p>     <div style="height:400px; overflow:auto; border:2px solid black;">    <div class="csharpcode">    <pre class="alt"><span class="rem">/* Author: Geoff Maggi</span></pre>    <pre><span class="rem"> * Class: CS 410: Introduction to Computer Vision</span></pre>    <pre class="alt"><span class="rem"> * Instructor: Feng Liu</span></pre>    <pre><span class="rem"> * </span></pre>    <pre class="alt"><span class="rem"> * About: Panorama Synthesis originally modeled after Matthew Brown and David G. Lowe, "Automatic panoramic image stitching using invariant features," International Journal of Computer Vision, 74, 1 (2007)</span></pre>    <pre><span class="rem"> *        Uses aForge and Accord as OpenCV wrappers and expands some on the above paper by also looking at other feature detection, filters and correlations</span></pre>    <pre class="alt"><span class="rem"> *        </span></pre>    <pre><span class="rem"> *  Documentation:</span></pre>    <pre class="alt"><span class="rem"> *    - http://www.cs.ubc.ca/~lowe/papers/07brown.pdf</span></pre>    <pre><span class="rem"> *    - http://www.aforgenet.com/framework/docs/</span></pre>    <pre class="alt"><span class="rem"> *    - http://accord-framework.net/docs/html/R_Project_Accord_NET.htm</span></pre>    <pre><span class="rem"> */</span></pre>    <pre class="alt">&nbsp;</pre>    <pre><span class="kwrd">using</span> System;</pre>    <pre class="alt"><span class="kwrd">using</span> System.Collections.Generic;</pre>    <pre><span class="kwrd">using</span> System.Linq;</pre>    <pre class="alt"><span class="kwrd">using</span> System.Web;</pre>    <pre><span class="kwrd">using</span> System.Web.UI;</pre>    <pre class="alt"><span class="kwrd">using</span> System.Web.UI.WebControls;</pre>    <pre><span class="kwrd">using</span> System.IO;</pre>    <pre class="alt"><span class="kwrd">using</span> System.Drawing;</pre>    <pre><span class="kwrd">using</span> System.Drawing.Imaging;</pre>    <pre class="alt">&nbsp;</pre>    <pre><span class="kwrd">using</span> AForge;</pre>    <pre class="alt"><span class="kwrd">using</span> Accord;</pre>    <pre><span class="kwrd">using</span> Accord.Math;</pre>    <pre class="alt"><span class="kwrd">using</span> Accord.Imaging;</pre>    <pre><span class="kwrd">using</span> Accord.Imaging.Filters;</pre>    <pre class="alt">&nbsp;</pre>    <pre><span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> _Default : System.Web.UI.Page {</pre>    <pre class="alt">&nbsp;</pre>    <pre>  <span class="kwrd">protected</span> <span class="kwrd">void</span> Page_Load(<span class="kwrd">object</span> sender, EventArgs e) {</pre>    <pre class="alt">&nbsp;</pre>    <pre>  }</pre>    <pre class="alt">&nbsp;</pre>    <pre>  <span class="kwrd">protected</span> <span class="kwrd">void</span> run(<span class="kwrd">object</span> sender, EventArgs e) {</pre>    <pre class="alt">    <span class="kwrd">if</span> (sourcesFU.HasFile) {</pre>    <pre>      List&lt;Bitmap&gt; imgs = <span class="kwrd">new</span> List&lt;Bitmap&gt;();</pre>    <pre class="alt">      </pre>    <pre>      <span class="rem">//Read in all the files to imgs</span></pre>    <pre class="alt">      HttpFileCollection files = Request.Files;</pre>    <pre>      <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; files.Count; i++) {</pre>    <pre class="alt">        imgs.Add(<span class="kwrd">new</span> Bitmap(files[i].InputStream));</pre>    <pre>      }</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="kwrd">switch</span> (taskDDL.SelectedValue) {</pre>    <pre class="alt">        <span class="kwrd">case</span> <span class="str">"fastHarrisRansacBlend"</span>:</pre>    <pre>          fastHarrisRansacBlend(imgs);</pre>    <pre class="alt">          <span class="kwrd">break</span>;</pre>    <pre>        <span class="kwrd">case</span> <span class="str">"harrisRansacBlend"</span>:</pre>    <pre class="alt">          harrisRansacBlend(imgs);</pre>    <pre>          <span class="kwrd">break</span>;</pre>    <pre class="alt">        <span class="kwrd">case</span> <span class="str">"surfRansacBlend"</span>:</pre>    <pre>          surfRansacBlend(imgs);</pre>    <pre class="alt">          <span class="kwrd">break</span>;</pre>    <pre>        <span class="kwrd">case</span> <span class="str">"freakRansacBlend"</span>:</pre>    <pre class="alt">          freakRansacBlend(imgs);</pre>    <pre>          <span class="kwrd">break</span>;</pre>    <pre class="alt">        <span class="kwrd">case</span> <span class="str">"fastHarrisRansacBlendStraight"</span>:</pre>    <pre>          fastHarrisRansacBlendStraight(imgs);</pre>    <pre class="alt">          <span class="kwrd">break</span>;</pre>    <pre>        <span class="kwrd">case</span> <span class="str">"harrisRansacBlendStraight"</span>:</pre>    <pre class="alt">          harrisRansacBlendStraight(imgs);</pre>    <pre>          <span class="kwrd">break</span>;</pre>    <pre class="alt">        <span class="kwrd">case</span> <span class="str">"surfRansacBlendStraight"</span>:</pre>    <pre>          surfRansacBlendStraight(imgs);</pre>    <pre class="alt">          <span class="kwrd">break</span>;</pre>    <pre>        <span class="kwrd">case</span> <span class="str">"fastHarrisFeaturesCorrelation"</span>:</pre>    <pre class="alt">          drawFastHarrisFeaturesCorrelations(imgs);</pre>    <pre>          <span class="kwrd">break</span>;</pre>    <pre class="alt">        <span class="kwrd">case</span> <span class="str">"harrisFeaturesCorrelation"</span>:</pre>    <pre>          drawHarrisFeaturesCorrelations(imgs);</pre>    <pre class="alt">          <span class="kwrd">break</span>;</pre>    <pre>        <span class="kwrd">case</span> <span class="str">"surfFeaturesCorrelation"</span>:</pre>    <pre class="alt">          drawSurfFeaturesCorrelations(imgs);</pre>    <pre>          <span class="kwrd">break</span>;</pre>    <pre class="alt">        <span class="kwrd">case</span> <span class="str">"freakFeaturesCorrelation"</span>:</pre>    <pre>          drawFreakFeaturesCorrelations(imgs);</pre>    <pre class="alt">          <span class="kwrd">break</span>;</pre>    <pre>        <span class="kwrd">case</span> <span class="str">"harrisFeatures"</span>:</pre>    <pre class="alt">          drawHarrisFeatures(imgs);</pre>    <pre>          <span class="kwrd">break</span>;</pre>    <pre class="alt">        <span class="kwrd">case</span> <span class="str">"surfFeatures"</span>:</pre>    <pre>          drawSurfFeatures(imgs);</pre>    <pre class="alt">          <span class="kwrd">break</span>;</pre>    <pre>        <span class="kwrd">case</span> <span class="str">"freakFeatures"</span>:</pre>    <pre class="alt">          drawFreakFeatures(imgs);</pre>    <pre>          <span class="kwrd">break</span>;</pre>    <pre class="alt">      }      </pre>    <pre>&nbsp;</pre>    <pre class="alt">    }</pre>    <pre>    <span class="kwrd">else</span> {</pre>    <pre class="alt">      debug.Text = <span class="str">"You forgot to select images :)"</span>;</pre>    <pre>    }</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> harrisRansacBlendStraight(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    List&lt;IntPoint[]&gt; harrisPoints = <span class="kwrd">new</span> List&lt;IntPoint[]&gt;();</pre>    <pre class="alt">    MatrixH homography;</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Calculate all the Harris Points</span></pre>    <pre>    HarrisCornersDetector harris = <span class="kwrd">new</span> HarrisCornersDetector(0.03f, 10000f);</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count; i++) {</pre>    <pre>      harrisPoints.Add(harris.ProcessImage(imgs[i]).ToArray());</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    Bitmap final = imgs[0];</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 1; i &lt; imgs.Count; i++) {</pre>    <pre>      <span class="rem">//Convert my frames to grayscale so I can find and adjust the normal vectors</span></pre>    <pre class="alt">      AForge.Imaging.Filters.GrayscaleBT709 grayscale = <span class="kwrd">new</span> AForge.Imaging.Filters.GrayscaleBT709();</pre>    <pre>      AForge.Imaging.DocumentSkewChecker skew = <span class="kwrd">new</span> AForge.Imaging.DocumentSkewChecker();</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="kwrd">double</span> finalAngle = skew.GetSkewAngle(grayscale.Apply(final));</pre>    <pre class="alt">      <span class="kwrd">double</span> imgAngle = skew.GetSkewAngle(grayscale.Apply(imgs[i]));</pre>    <pre>&nbsp;</pre>    <pre class="alt">      <span class="rem">//Less than 5% to account for human error with rotations and wobbles</span></pre>    <pre>      <span class="kwrd">if</span> (Math.Abs(finalAngle - imgAngle) &lt; 5) {</pre>    <pre class="alt">        AForge.Imaging.Filters.RotateBilinear rotate = <span class="kwrd">new</span> AForge.Imaging.Filters.RotateBilinear(finalAngle - imgAngle);</pre>    <pre>        rotate.FillColor = Color.FromArgb(0, 255, 255, 255);</pre>    <pre class="alt">        imgs[i] = rotate.Apply(imgs[i]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">        <span class="rem">//Update harris</span></pre>    <pre>        harrisPoints[i] = harris.ProcessImage(imgs[i]).ToArray();</pre>    <pre class="alt">      }</pre>    <pre>&nbsp;</pre>    <pre class="alt">      IntPoint[] harrisFinal = harris.ProcessImage(final).ToArray();</pre>    <pre>&nbsp;</pre>    <pre class="alt">      <span class="rem">//Correlate the Harris pts between imgs</span></pre>    <pre>      CorrelationMatching matcher = <span class="kwrd">new</span> CorrelationMatching(49, final, imgs[i]);</pre>    <pre class="alt">      IntPoint[][] matches = matcher.Match(harrisFinal, harrisPoints[i]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">      <span class="rem">//Create the homography matrix using a RANSAC</span></pre>    <pre>      RansacHomographyEstimator ransac = <span class="kwrd">new</span> RansacHomographyEstimator(1, 0.99);</pre>    <pre class="alt">      homography = ransac.Estimate(matches[0], matches[1]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">      Blend blend = <span class="kwrd">new</span> Blend(homography, final);</pre>    <pre>      blend.Gradient = <span class="kwrd">true</span>;</pre>    <pre class="alt">      final = blend.Apply(imgs[i]);</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>    showImage(final);</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> surfRansacBlendStraight(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    MatrixH homography;</pre>    <pre class="alt">&nbsp;</pre>    <pre>    List&lt;SpeededUpRobustFeaturePoint[]&gt; surfPoints = <span class="kwrd">new</span> List&lt;SpeededUpRobustFeaturePoint[]&gt;();</pre>    <pre class="alt">    <span class="rem">//Calculate all the Surf Points</span></pre>    <pre>    SpeededUpRobustFeaturesDetector surf = <span class="kwrd">new</span> SpeededUpRobustFeaturesDetector();</pre>    <pre class="alt">    <span class="kwrd">double</span> lastAngle = 0;</pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count; i++) {</pre>    <pre class="alt">      <span class="rem">//Grayscale to find the edges and adjust the normal to point up</span></pre>    <pre>      AForge.Imaging.Filters.GrayscaleBT709 grayscale = <span class="kwrd">new</span> AForge.Imaging.Filters.GrayscaleBT709();</pre>    <pre class="alt">      AForge.Imaging.DocumentSkewChecker skew = <span class="kwrd">new</span> AForge.Imaging.DocumentSkewChecker();</pre>    <pre>&nbsp;</pre>    <pre class="alt">      <span class="kwrd">double</span> angle = skew.GetSkewAngle(grayscale.Apply(imgs[i]));</pre>    <pre>&nbsp;</pre>    <pre class="alt">      <span class="rem">//Less than 5 deg change in angle to account for wobble, ignore big shifts</span></pre>    <pre>      <span class="kwrd">if</span> (Math.Abs(angle - lastAngle) &lt; 5) {</pre>    <pre class="alt">        AForge.Imaging.Filters.RotateBilinear rotate = <span class="kwrd">new</span> AForge.Imaging.Filters.RotateBilinear(angle);</pre>    <pre>        rotate.FillColor = Color.FromArgb(0, 255, 255, 255);</pre>    <pre class="alt">        imgs[i] = rotate.Apply(imgs[i]);</pre>    <pre>        lastAngle = angle;</pre>    <pre class="alt">      }</pre>    <pre>      showImage(imgs[i]);</pre>    <pre class="alt">      surfPoints.Add(surf.ProcessImage(imgs[i]).ToArray());</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>&nbsp;</pre>    <pre class="alt">    Bitmap final = imgs[0];</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 1; i &lt; imgs.Count; i++) {</pre>    <pre>      SpeededUpRobustFeaturePoint[] surfFinal = surf.ProcessImage(final).ToArray();</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Correlate the Harris pts between imgs</span></pre>    <pre class="alt">      KNearestNeighborMatching matcher = <span class="kwrd">new</span> KNearestNeighborMatching(5);</pre>    <pre>      matcher.Threshold = 0.05;</pre>    <pre class="alt">&nbsp;</pre>    <pre>      IntPoint[][] matches = matcher.Match(surfFinal, surfPoints[i]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Create the homography matrix using RANSAC</span></pre>    <pre class="alt">      RansacHomographyEstimator ransac = <span class="kwrd">new</span> RansacHomographyEstimator(0.015, 1);</pre>    <pre>      homography = ransac.Estimate(matches[0], matches[1]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      Blend blend = <span class="kwrd">new</span> Blend(homography, final);</pre>    <pre class="alt">      blend.Gradient = <span class="kwrd">true</span>;</pre>    <pre>      final = blend.Apply(imgs[i]);</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Smooth/Sharpen if I wanted to</span></pre>    <pre>    AForge.Imaging.Filters.Sharpen filter = <span class="kwrd">new</span> AForge.Imaging.Filters.Sharpen();</pre>    <pre class="alt">    <span class="rem">//AForge.Imaging.Filters.Gaussian filter = new AForge.Imaging.Filters.Guassian(5);</span></pre>    <pre>    <span class="rem">//filter.ApplyInPlace(final);</span></pre>    <pre class="alt">&nbsp;</pre>    <pre>    showImage(final);</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> harrisRansacBlend(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    List&lt;IntPoint[]&gt; harrisPoints = <span class="kwrd">new</span> List&lt;IntPoint[]&gt;();</pre>    <pre class="alt">    MatrixH homography;</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Calculate all the Harris Points</span></pre>    <pre>    HarrisCornersDetector harris = <span class="kwrd">new</span> HarrisCornersDetector(0.03f, 10000f);</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count; i++) {</pre>    <pre>      harrisPoints.Add(harris.ProcessImage(imgs[i]).ToArray());</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    Bitmap final = imgs[0];</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 1; i &lt; imgs.Count; i++) {</pre>    <pre>      IntPoint[] harrisFinal = harris.ProcessImage(final).ToArray();</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Correlate the Harris pts between imgs</span></pre>    <pre class="alt">      CorrelationMatching matcher = <span class="kwrd">new</span> CorrelationMatching(99, final, imgs[i]);</pre>    <pre>      IntPoint[][] matches = matcher.Match(harrisFinal, harrisPoints[i]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Create the homography matrix using ransac</span></pre>    <pre class="alt">      RansacHomographyEstimator ransac = <span class="kwrd">new</span> RansacHomographyEstimator(1, 0.99);</pre>    <pre>      homography = ransac.Estimate(matches[0], matches[1]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      Blend blend = <span class="kwrd">new</span> Blend(homography, final);</pre>    <pre class="alt">      blend.Gradient = <span class="kwrd">true</span>;</pre>    <pre>      final = blend.Apply(imgs[i]);</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    showImage(final);</pre>    <pre>  }</pre>    <pre class="alt">&nbsp;</pre>    <pre>  <span class="rem">//Relies less on neighbor pixels and more on RANSAC</span></pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> fastHarrisRansacBlend(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    List&lt;IntPoint[]&gt; harrisPoints = <span class="kwrd">new</span> List&lt;IntPoint[]&gt;();</pre>    <pre class="alt">    MatrixH homography;</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Calculate all the Harris Points</span></pre>    <pre>    HarrisCornersDetector harris = <span class="kwrd">new</span> HarrisCornersDetector(0.03f, 10000f);</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count; i++) {</pre>    <pre>      harrisPoints.Add(harris.ProcessImage(imgs[i]).ToArray());</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    Bitmap final = imgs[0];</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 1; i &lt; imgs.Count; i++) {</pre>    <pre>      IntPoint[] harrisFinal = harris.ProcessImage(final).ToArray();</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Correlate the Harris pts between imgs</span></pre>    <pre class="alt">      CorrelationMatching matcher = <span class="kwrd">new</span> CorrelationMatching(5, final, imgs[i]);</pre>    <pre>      IntPoint[][] matches = matcher.Match(harrisFinal, harrisPoints[i]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Create the homography matrix using ransac</span></pre>    <pre class="alt">      RansacHomographyEstimator ransac = <span class="kwrd">new</span> RansacHomographyEstimator(0.025, 0.99);</pre>    <pre>      homography = ransac.Estimate(matches[0], matches[1]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      Blend blend = <span class="kwrd">new</span> Blend(homography, final);</pre>    <pre class="alt">      blend.Gradient = <span class="kwrd">true</span>;</pre>    <pre>      final = blend.Apply(imgs[i]);</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    showImage(final);</pre>    <pre>  }</pre>    <pre class="alt">&nbsp;</pre>    <pre>  <span class="kwrd">protected</span> <span class="kwrd">void</span> fastHarrisRansacBlendStraight(List&lt;Bitmap&gt; imgs) {</pre>    <pre class="alt">    List&lt;IntPoint[]&gt; harrisPoints = <span class="kwrd">new</span> List&lt;IntPoint[]&gt;();</pre>    <pre>    MatrixH homography;</pre>    <pre class="alt">&nbsp;</pre>    <pre>    <span class="rem">//Calculate all the Harris Points</span></pre>    <pre class="alt">    HarrisCornersDetector harris = <span class="kwrd">new</span> HarrisCornersDetector(0.03f, 10000f);</pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count; i++) {</pre>    <pre class="alt">      harrisPoints.Add(harris.ProcessImage(imgs[i]).ToArray());</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>    Bitmap final = imgs[0];</pre>    <pre class="alt">&nbsp;</pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 1; i &lt; imgs.Count; i++) {</pre>    <pre class="alt">      <span class="rem">//Convert my frames to grayscale so I can find and adjust the normal vectors</span></pre>    <pre>      AForge.Imaging.Filters.GrayscaleBT709 grayscale = <span class="kwrd">new</span> AForge.Imaging.Filters.GrayscaleBT709();</pre>    <pre class="alt">      AForge.Imaging.DocumentSkewChecker skew = <span class="kwrd">new</span> AForge.Imaging.DocumentSkewChecker();</pre>    <pre>&nbsp;</pre>    <pre class="alt">      <span class="kwrd">double</span> finalAngle = skew.GetSkewAngle(grayscale.Apply(final));</pre>    <pre>      <span class="kwrd">double</span> imgAngle = skew.GetSkewAngle(grayscale.Apply(imgs[i]));</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Less than 5% to account for human error with rotations and wobbles</span></pre>    <pre class="alt">      <span class="kwrd">if</span> (Math.Abs(finalAngle - imgAngle) &lt; 5) {</pre>    <pre>        AForge.Imaging.Filters.RotateBilinear rotate = <span class="kwrd">new</span> AForge.Imaging.Filters.RotateBilinear(finalAngle - imgAngle);</pre>    <pre class="alt">        rotate.FillColor = Color.FromArgb(0, 255, 255, 255);</pre>    <pre>        imgs[i] = rotate.Apply(imgs[i]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>        <span class="rem">//Update harris</span></pre>    <pre class="alt">        harrisPoints[i] = harris.ProcessImage(imgs[i]).ToArray();</pre>    <pre>      }</pre>    <pre class="alt">&nbsp;</pre>    <pre>      IntPoint[] harrisFinal = harris.ProcessImage(final).ToArray();</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Correlate the Harris pts between imgs</span></pre>    <pre class="alt">      CorrelationMatching matcher = <span class="kwrd">new</span> CorrelationMatching(5, final, imgs[i]);</pre>    <pre>      IntPoint[][] matches = matcher.Match(harrisFinal, harrisPoints[i]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Create the homography matrix using ransac</span></pre>    <pre class="alt">      RansacHomographyEstimator ransac = <span class="kwrd">new</span> RansacHomographyEstimator(0.025, 0.99);</pre>    <pre>      homography = ransac.Estimate(matches[0], matches[1]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      Blend blend = <span class="kwrd">new</span> Blend(homography, final);</pre>    <pre class="alt">      blend.Gradient = <span class="kwrd">true</span>;</pre>    <pre>      final = blend.Apply(imgs[i]);</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    showImage(final);</pre>    <pre>  }</pre>    <pre class="alt">&nbsp;</pre>    <pre>  <span class="kwrd">protected</span> <span class="kwrd">void</span> surfRansacBlend(List&lt;Bitmap&gt; imgs) {</pre>    <pre class="alt">    MatrixH homography;</pre>    <pre>&nbsp;</pre>    <pre class="alt">    List&lt;SpeededUpRobustFeaturePoint[]&gt; surfPoints = <span class="kwrd">new</span> List&lt;SpeededUpRobustFeaturePoint[]&gt;();</pre>    <pre>    <span class="rem">//Calculate all the Surf Points</span></pre>    <pre class="alt">    SpeededUpRobustFeaturesDetector surf = <span class="kwrd">new</span> SpeededUpRobustFeaturesDetector();</pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count; i++) {</pre>    <pre class="alt">      surfPoints.Add(surf.ProcessImage(imgs[i]).ToArray());</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>&nbsp;</pre>    <pre class="alt">    Bitmap final = imgs[0];</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 1; i &lt; imgs.Count; i++) {</pre>    <pre>      SpeededUpRobustFeaturePoint[] surfFinal = surf.ProcessImage(final).ToArray();</pre>    <pre class="alt">&nbsp;</pre>    <pre>      <span class="rem">//Correlate the Harris pts between imgs</span></pre>    <pre class="alt">      KNearestNeighborMatching matcher = <span class="kwrd">new</span> KNearestNeighborMatching(20);</pre>    <pre>      matcher.Threshold = 0.06;</pre>    <pre class="alt">&nbsp;</pre>    <pre>      IntPoint[][] matches = matcher.Match(surfFinal, surfPoints[i]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      RansacHomographyEstimator ransac = <span class="kwrd">new</span> RansacHomographyEstimator(0.015, 1);</pre>    <pre class="alt">      homography = ransac.Estimate(matches[0], matches[1]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">      Blend blend = <span class="kwrd">new</span> Blend(homography, final);</pre>    <pre>      blend.Gradient = <span class="kwrd">true</span>;</pre>    <pre class="alt">      final = blend.Apply(imgs[i]);</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>    <span class="rem">//Smooth/Sharpen if I wanted to</span></pre>    <pre class="alt">    AForge.Imaging.Filters.Sharpen filter = <span class="kwrd">new</span> AForge.Imaging.Filters.Sharpen();</pre>    <pre>    <span class="rem">//AForge.Imaging.Filters.Gaussian filter = new AForge.Imaging.Filters.Guassian(5);</span></pre>    <pre class="alt">    <span class="rem">//filter.ApplyInPlace(final);</span></pre>    <pre>&nbsp;</pre>    <pre class="alt">    showImage(final);</pre>    <pre>  }</pre>    <pre class="alt">&nbsp;</pre>    <pre>  <span class="kwrd">protected</span> <span class="kwrd">void</span> freakRansacBlend(List&lt;Bitmap&gt; imgs) {</pre>    <pre class="alt">    MatrixH homography;</pre>    <pre>&nbsp;</pre>    <pre class="alt">    List&lt;FastRetinaKeypoint[]&gt; freakPoints = <span class="kwrd">new</span> List&lt;FastRetinaKeypoint[]&gt;();</pre>    <pre>    <span class="rem">//Calculate all the FREAK Points</span></pre>    <pre class="alt">    FastRetinaKeypointDetector freak = <span class="kwrd">new</span> FastRetinaKeypointDetector();</pre>    <pre>    <span class="kwrd">foreach</span> (Bitmap img <span class="kwrd">in</span> imgs) {</pre>    <pre class="alt">      freakPoints.Add(freak.ProcessImage(img).ToArray());</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>    <span class="rem">//Map them and draw them!</span></pre>    <pre class="alt">    Bitmap final = imgs[0];</pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 1; i &lt; imgs.Count; i++) {</pre>    <pre class="alt">      FastRetinaKeypoint[] freakFinal = freak.ProcessImage(final).ToArray();</pre>    <pre>      </pre>    <pre class="alt">      KNearestNeighborMatching matcher = <span class="kwrd">new</span> KNearestNeighborMatching(500);</pre>    <pre>      matcher.Threshold = 0.005;</pre>    <pre class="alt">      IntPoint[][] matches = matcher.Match(freakFinal, freakPoints[i]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">      RansacHomographyEstimator ransac = <span class="kwrd">new</span> RansacHomographyEstimator(0.015, 1);</pre>    <pre>      homography = ransac.Estimate(matches[0], matches[1]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      Blend blend = <span class="kwrd">new</span> Blend(homography, final);</pre>    <pre class="alt">      blend.Gradient = <span class="kwrd">true</span>;</pre>    <pre>      final = blend.Apply(imgs[i]);</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Smooth/Sharpen if I wanted to</span></pre>    <pre>    AForge.Imaging.Filters.Sharpen filter = <span class="kwrd">new</span> AForge.Imaging.Filters.Sharpen();</pre>    <pre class="alt">    <span class="rem">//AForge.Imaging.Filters.Gaussian filter = new AForge.Imaging.Filters.Guassian(5);</span></pre>    <pre>    <span class="rem">//filter.ApplyInPlace(final);</span></pre>    <pre class="alt">&nbsp;</pre>    <pre>    showImage(final);</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> drawFastHarrisFeaturesCorrelations(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    List&lt;IntPoint[]&gt; harrisPoints = <span class="kwrd">new</span> List&lt;IntPoint[]&gt;();</pre>    <pre class="alt">    MatrixH homography;</pre>    <pre>    <span class="rem">//Calculate all the Harris Points</span></pre>    <pre class="alt">    HarrisCornersDetector harris = <span class="kwrd">new</span> HarrisCornersDetector(0.03f, 10000f);</pre>    <pre>    <span class="kwrd">foreach</span> (Bitmap img <span class="kwrd">in</span> imgs) {</pre>    <pre class="alt">      harrisPoints.Add(harris.ProcessImage(img).ToArray());</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>    <span class="rem">//Map them and draw them!</span></pre>    <pre class="alt">    Bitmap harrisImg = imgs[0];</pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count - 1; i++) {</pre>    <pre class="alt">      <span class="rem">//Correlate the Harris pts between imgs</span></pre>    <pre>      CorrelationMatching matcher = <span class="kwrd">new</span> CorrelationMatching(5, imgs[i], imgs[i + 1]);</pre>    <pre class="alt">      IntPoint[][] matches = matcher.Match(harrisPoints[i], harrisPoints[i + 1]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">      <span class="rem">//Create the homography matrix using ransac</span></pre>    <pre>      RansacHomographyEstimator ransac = <span class="kwrd">new</span> RansacHomographyEstimator(0.025, 0.99);</pre>    <pre class="alt">      homography = ransac.Estimate(matches[0], matches[1]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">      Concatenate concat = <span class="kwrd">new</span> Concatenate(harrisImg);</pre>    <pre>      Bitmap img = concat.Apply(imgs[i + 1]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      Color color = Color.White;</pre>    <pre class="alt">      <span class="kwrd">if</span> (i % 3 == 1) color = Color.OrangeRed;</pre>    <pre>      <span class="kwrd">if</span> (i % 3 == 2) color = Color.Blue;</pre>    <pre class="alt">      PairsMarker pairs = <span class="kwrd">new</span> PairsMarker(matches[0].Apply(p =&gt; <span class="kwrd">new</span> IntPoint(p.X + harrisImg.Width - imgs[0].Width, p.Y)), matches[1].Apply(p =&gt; <span class="kwrd">new</span> IntPoint(p.X + harrisImg.Width, p.Y)), color);</pre>    <pre>      harrisImg = pairs.Apply(img);</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    showImage(harrisImg);</pre>    <pre>  }</pre>    <pre class="alt">&nbsp;</pre>    <pre>  <span class="kwrd">protected</span> <span class="kwrd">void</span> drawHarrisFeaturesCorrelations(List&lt;Bitmap&gt; imgs) {</pre>    <pre class="alt">    List&lt;IntPoint[]&gt; harrisPoints = <span class="kwrd">new</span> List&lt;IntPoint[]&gt;();</pre>    <pre>    <span class="rem">//Calculate all the Harris Points</span></pre>    <pre class="alt">    HarrisCornersDetector harris = <span class="kwrd">new</span> HarrisCornersDetector(0.03f, 10000f);</pre>    <pre>    <span class="kwrd">foreach</span> (Bitmap img <span class="kwrd">in</span> imgs) {</pre>    <pre class="alt">      harrisPoints.Add(harris.ProcessImage(img).ToArray());</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>    <span class="rem">//Map them and draw them!</span></pre>    <pre class="alt">    Bitmap harrisImg = imgs[0];</pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count - 1; i++) {</pre>    <pre class="alt">      CorrelationMatching matcher = <span class="kwrd">new</span> CorrelationMatching(99, imgs[i], imgs[i + 1]);</pre>    <pre>      IntPoint[][] matches = matcher.Match(harrisPoints[i], harrisPoints[i + 1]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      Concatenate concat = <span class="kwrd">new</span> Concatenate(harrisImg);</pre>    <pre class="alt">      Bitmap img3 = concat.Apply(imgs[i + 1]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">      Color color = Color.White;</pre>    <pre>      <span class="kwrd">if</span> (i % 3 == 1) color = Color.OrangeRed;</pre>    <pre class="alt">      <span class="kwrd">if</span> (i % 3 == 2) color = Color.Blue;</pre>    <pre>      PairsMarker pairs = <span class="kwrd">new</span> PairsMarker(matches[0].Apply(p =&gt; <span class="kwrd">new</span> IntPoint(p.X + harrisImg.Width - imgs[0].Width, p.Y)), matches[1].Apply(p =&gt; <span class="kwrd">new</span> IntPoint(p.X + harrisImg.Width, p.Y)), color);</pre>    <pre class="alt">      harrisImg = pairs.Apply(img3);</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>    showImage(harrisImg);</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> drawHarrisFeatures(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    List&lt;IntPoint[]&gt; harrisPoints = <span class="kwrd">new</span> List&lt;IntPoint[]&gt;();</pre>    <pre class="alt">    <span class="rem">//Calculate all the Harris Points</span></pre>    <pre>    HarrisCornersDetector harris = <span class="kwrd">new</span> HarrisCornersDetector(0.03f, 10000f);</pre>    <pre class="alt">    <span class="kwrd">foreach</span> (Bitmap img <span class="kwrd">in</span> imgs) {</pre>    <pre>      harrisPoints.Add(harris.ProcessImage(img).ToArray());</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Draw &amp; Show all the harris points</span></pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count; i++) {</pre>    <pre class="alt">      showImage(<span class="kwrd">new</span> PointsMarker(harrisPoints[i]).Apply(imgs[i]));</pre>    <pre>    }</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> drawSurfFeaturesCorrelations(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    List&lt;SpeededUpRobustFeaturePoint[]&gt; surfPoints = <span class="kwrd">new</span> List&lt;SpeededUpRobustFeaturePoint[]&gt;();</pre>    <pre class="alt">    <span class="rem">//Calculate all the Surf Points</span></pre>    <pre>    SpeededUpRobustFeaturesDetector surf = <span class="kwrd">new</span> SpeededUpRobustFeaturesDetector();</pre>    <pre class="alt">    <span class="kwrd">foreach</span> (Bitmap img <span class="kwrd">in</span> imgs) {</pre>    <pre>      surfPoints.Add(surf.ProcessImage(img).ToArray());</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Map them and draw them!</span></pre>    <pre>    Bitmap surfImg = imgs[0];</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count - 1; i++) {</pre>    <pre>      KNearestNeighborMatching matcher = <span class="kwrd">new</span> KNearestNeighborMatching(20);</pre>    <pre class="alt">      matcher.Threshold = 0.06;</pre>    <pre>      IntPoint[][] matches = matcher.Match(surfPoints[i], surfPoints[i + 1]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      Concatenate concat = <span class="kwrd">new</span> Concatenate(surfImg);</pre>    <pre class="alt">      Bitmap img = concat.Apply(imgs[i + 1]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">      Color color = Color.White;</pre>    <pre>      <span class="kwrd">if</span> (i % 3 == 1) color = Color.OrangeRed;</pre>    <pre class="alt">      <span class="kwrd">if</span> (i % 3 == 2) color = Color.Blue;</pre>    <pre>      PairsMarker pairs = <span class="kwrd">new</span> PairsMarker(matches[0].Apply(p =&gt; <span class="kwrd">new</span> IntPoint(p.X + surfImg.Width - imgs[0].Width, p.Y)), matches[1].Apply(p =&gt; <span class="kwrd">new</span> IntPoint(p.X + surfImg.Width, p.Y)), color);</pre>    <pre class="alt">      surfImg = pairs.Apply(img);</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>    showImage(surfImg);</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> drawSurfFeatures(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    List&lt;SpeededUpRobustFeaturePoint[]&gt; surfPoints = <span class="kwrd">new</span> List&lt;SpeededUpRobustFeaturePoint[]&gt;();</pre>    <pre class="alt">    <span class="rem">//Calculate all the Surf Points</span></pre>    <pre>    SpeededUpRobustFeaturesDetector surf = <span class="kwrd">new</span> SpeededUpRobustFeaturesDetector();</pre>    <pre class="alt">    <span class="kwrd">foreach</span> (Bitmap img <span class="kwrd">in</span> imgs) {</pre>    <pre>      surfPoints.Add(surf.ProcessImage(img).ToArray());</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Draw &amp; Show all the harris points</span></pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count; i++) {</pre>    <pre class="alt">      showImage(<span class="kwrd">new</span> PointsMarker(surfPoints[i]).Apply(imgs[i]));</pre>    <pre>    }</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> drawFreakFeaturesCorrelations(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    List&lt;FastRetinaKeypoint[]&gt; freakPoints = <span class="kwrd">new</span> List&lt;FastRetinaKeypoint[]&gt;();</pre>    <pre class="alt">    <span class="rem">//Calculate all the FREAK Points</span></pre>    <pre>    FastRetinaKeypointDetector freak = <span class="kwrd">new</span> FastRetinaKeypointDetector();</pre>    <pre class="alt">    <span class="kwrd">foreach</span> (Bitmap img <span class="kwrd">in</span> imgs) {</pre>    <pre>      freakPoints.Add(freak.ProcessImage(img).ToArray());</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Map them and draw them!</span></pre>    <pre>    Bitmap img2 = imgs[0];</pre>    <pre class="alt">    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count - 1; i++) {</pre>    <pre>      KNearestNeighborMatching matcher = <span class="kwrd">new</span> KNearestNeighborMatching(200);</pre>    <pre class="alt">      matcher.Threshold = 0.015;</pre>    <pre>      IntPoint[][] matches = matcher.Match(freakPoints[i], freakPoints[i+1]);</pre>    <pre class="alt">&nbsp;</pre>    <pre>      Concatenate concat = <span class="kwrd">new</span> Concatenate(img2);</pre>    <pre class="alt">      Bitmap img3 = concat.Apply(imgs[i + 1]);</pre>    <pre>&nbsp;</pre>    <pre class="alt">      Color color = Color.White;</pre>    <pre>      <span class="kwrd">if</span> (i % 3 == 1) color = Color.OrangeRed;</pre>    <pre class="alt">      <span class="kwrd">if</span> (i % 3 == 2) color = Color.Blue;</pre>    <pre>      PairsMarker pairs = <span class="kwrd">new</span> PairsMarker(matches[0].Apply(p =&gt; <span class="kwrd">new</span> IntPoint(p.X + img2.Width - imgs[0].Width, p.Y)), matches[1].Apply(p =&gt; <span class="kwrd">new</span> IntPoint(p.X + img2.Width, p.Y)), color);</pre>    <pre class="alt">      img2 = pairs.Apply(img3);</pre>    <pre>    }</pre>    <pre class="alt">&nbsp;</pre>    <pre>    showImage(img2);</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="kwrd">protected</span> <span class="kwrd">void</span> drawFreakFeatures(List&lt;Bitmap&gt; imgs) {</pre>    <pre>    List&lt;FastRetinaKeypoint[]&gt; freakPoints = <span class="kwrd">new</span> List&lt;FastRetinaKeypoint[]&gt;();</pre>    <pre class="alt">    <span class="rem">//Calculate all the FREAK Points</span></pre>    <pre>    FastRetinaKeypointDetector freak = <span class="kwrd">new</span> FastRetinaKeypointDetector();</pre>    <pre class="alt">    <span class="kwrd">foreach</span> (Bitmap img <span class="kwrd">in</span> imgs) {</pre>    <pre>      freakPoints.Add(freak.ProcessImage(img).ToArray());</pre>    <pre class="alt">    }</pre>    <pre>&nbsp;</pre>    <pre class="alt">    <span class="rem">//Draw &amp; Show all the harris points</span></pre>    <pre>    <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; imgs.Count; i++) {</pre>    <pre class="alt">      showImage(<span class="kwrd">new</span> PointsMarker(freakPoints[i]).Apply(imgs[i]));</pre>    <pre>    }</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="rem">//Addes the image to ImageUP</span></pre>    <pre>  <span class="kwrd">protected</span> <span class="kwrd">void</span> showImage(Bitmap img) {</pre>    <pre class="alt">    MemoryStream ms = <span class="kwrd">new</span> MemoryStream();</pre>    <pre>    img.Save(ms, ImageFormat.Jpeg);</pre>    <pre class="alt">    <span class="kwrd">var</span> base64Data = Convert.ToBase64String(ms.ToArray());</pre>    <pre>&nbsp;</pre>    <pre class="alt">    System.Web.UI.WebControls.Image newImg = <span class="kwrd">new</span> System.Web.UI.WebControls.Image();</pre>    <pre>    newImg.ImageUrl = <span class="str">"data:image/jpg;base64,"</span> + base64Data;</pre>    <pre class="alt">    newImg.Visible = <span class="kwrd">true</span>;</pre>    <pre>    imageUP.ContentTemplateContainer.Controls.Add(newImg);</pre>    <pre class="alt">  }</pre>    <pre>&nbsp;</pre>    <pre class="alt">  <span class="rem">//Clears the form and the Image Panel</span></pre>    <pre>  <span class="kwrd">protected</span> <span class="kwrd">void</span> clear(<span class="kwrd">object</span> sender, EventArgs e) {</pre>    <pre class="alt">    sourcesFU.Attributes.Clear();</pre>    <pre>    sourcesFU.Attributes.Add(<span class="str">"Multiple"</span>, <span class="str">"Multiple"</span>);</pre>    <pre class="alt">    </pre>    <pre>    imageUP.ContentTemplateContainer.Controls.Clear();</pre>    <pre class="alt">  }</pre>    <pre>}</pre>    </div> </div> <p>&nbsp;</p> <p>&nbsp;</p>
</body></html>